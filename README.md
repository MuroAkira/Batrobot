# Batrobot — サーモホン制御／ADC計測ツール（C + Python）

Thermophone（サーモホン）を **Linux上で制御**し、**ADC（ステレオ）で受信した生データを保存・解析**するためのツール群です。  
Cプログラムで「送信→受信→保存」まで確実に行い、Pythonで波形・スペクトログラム・相互相関（マッチドフィルタ）による距離推定を行います。

> 重要：このプロジェクトは **リアルタイム処理が必須ではありません**。  
> まずは確実にデータを取り、オフラインで相互相関を回して「検知できる」状態を作るのが主目的です。

---

## 1. 目的（What / Why）

このリポジトリがやりたいことは以下です：

1. サーモホンに狙ったパルス列を出力する（CF / FMチャープ）
2. マイク（ADC）で受信して、生データを取りこぼしなく保存する
3. 生データを WAV / 波形 / スペクトログラムで確認できるようにする
4. 送信参照波形と受信波形の **相互相関**で反射（エコー）ピークを検出し、距離推定につなげる（障害物検知）

---

## 2. 現状できていること（Status）

### ✅ 送信（PULSE）
- CF（固定周波数）パルス出力
- FM（指数チャープ）パルス出力（送信ビット列生成 → PortAへ送信）
- 送信したパルスを `output/pulse_data/` に保存（再現のため）

### ✅ 受信（ADC）
- ADCからステレオ生データを取得し `bin` として保存
- 指定バイト数（例：256000 bytes）を満たす受信ができることを確認

### ✅ 解析（オフライン）
- `bin → wav` 変換して波形確認できる
- WAVを使ってスペクトログラム表示できる
- 相互相関で「direct（直達）」と「echo（反射）」候補を探索できる（距離推定の土台）

---

## 3. 今やっているタスク（Now）

### 🎯 タスクA：障害物検知（距離推定）を安定化
- 目標距離：**1m / 2.5m**
- 送信条件（duration / duty / FM帯域）と SNR を調整し、
  - 反射ピークが安定して出る
  - distance推定がそれっぽい値になる  
 ところまで持っていく

### 🎯 タスクB：誰が触っても再現できる形に整理
- 設定（デバイスパス、read bytes、サンプル周波数）を迷わない形に固定
- 出力（output配下）をgit管理しない（`.gitignore`）
- 測定→解析の手順を README / docs に標準化

---

## 4. システム概要（全体像）

### 4.1 ポート役割（USBシリアル）
`include/config.h` でデバイスパスを指定します。

- **PULSE（FT2232H PortA）**：パルスデータ送信（出力）
- **ADC（FT2232H PortB）**：ADCデータ受信（入力）
- **CTRL（CP210x / PortC相当）**：ゲイン設定、エラー取得など制御

> USBの挿し順で `/dev/ttyUSB*` が入れ替わることがあります。  
> 可能なら `/dev/serial/by-id/` を使って固定するのが推奨です。

---

## 5. リポジトリ構成（Overview）

```text
.
├─ C/
│  ├─ Makefile
│  ├─ include/
│  │   ├─ config.h        # デバイスパス/ボーレート/タイムアウト等
│  │   ├─ ctrl_port.h     # CTRLポートI/F
│  │   ├─ pulse_port.h    # PULSEポートI/F（送信）
│  │   ├─ adc_port.h      # ADCポートI/F（受信）
│  │   └─ timing.h        # 補助（必要に応じて）
│  ├─ src/
│  │   ├─ main.c          # 実行エントリ：送信→受信→保存
│  │   ├─ ctrl_port.c     # ゲイン設定・エラー取得など
│  │   ├─ pulse_port.c    # パルス生成＆送信（安全ゲートあり）
│  │   ├─ adc_port.c      # ADC受信（read/flush）
│  │   ├─ crosscorr.c     # 相互相関（C側で使う場合）
│  │   └─ timing.c        # 補助
│  └─ build/              # ビルド生成物
├─ tools/
│  ├─ bin2wav.py          # ADC binをwavへ変換
│  └─ (analysis scripts)  # Python解析（追加していく）
└─ output/
   ├─ pulse_data/         # 送信データ（確認用）
   └─ adc_data/           # ADCデータ（bin/wavなど）
