new_bat_robotの説明書

・ファイル構造：
C/
├─ Makefile
├─ README.md
│
├─ include/
│   ├─ config.h
│   ├─ ctrl_port.h
│   ├─ pulse_port.h
│   ├─ adc_port.h
│   └─ timing.h
│
├─ src/
│   ├─ main.c 
│   ├─ ctrl_port.c
│   ├─ pulse_port.c
│   ├─ adc_port.c
│   └─ timing.c
│
└─ build/

ファイルの役割
① main.c
【意味】
司令塔
【責務】
プログラムの流れを決める
初期化の順番を管理
各モジュールを「呼ぶだけ」

② ctrl_port.c / ctrl_port.h
【意味】
制御ポート専用（CP210x）
【担当ポート】
/dev/ttyUSB2
【責務】
・termios でポートを開く
・ENQ → ACK 確認
・f, g, b, t, e コマンド送信
・状態取得（数値を読む）

③ pulse_port.c / pulse_port.h
【意味】
サーモホン駆動用（FT2232H PortA）
【担当ポート】
/dev/ttyUSB0
【責務】
・大量バイト列の write
・送信バッファ管理
・「返ってこない前提」で動く
【重要】
・read() は 絶対に書かない
・write() 専用
→ADCより後に実装

④ adc_port.c / adc_port.h
【意味】
ADCデータ取得専用（FT2232H PortB）
【担当ポート】
/dev/ttyUSB1
【責務】
・read() のみ
・4MB/s を落とさず読む
・バッファリング
・ファイル書き出し用の生データ生成
【重要】
・printf 禁止
・malloc をループ内で使わない
・とにかく「止まらない」ことが使命
→ 一番最後に作る

⑤ timing.c / timing.h
【意味】
測定シーケンス管理
【責務】
・「いつ何をするか」
・パルス送信とADC受信の同期
・t1 / t2 / t3 の関係制御
【ポイント】
・シリアルI/Oは呼ばない
・ロジックだけを書く
→ main とモジュールの橋渡し

⑥ config.h
【意味】
全体の共通設定ファイル
【中身】
・デバイスパス
・バッファサイズ
・タイムアウト
・サンプリング周波数上限
→ マジックナンバーは全部ここへ

・開発の流れ：注意レベルにわけて開発を進める
レベル0：安全（音が出ない）
目的：土台を固める
0-1) Cプロジェクトがビルドできる（ダミーmainでOK）
0-2) Cで制御ポートを open/close できる
0-3) Cで ENQ→ACK が取れる
0-4) Cで f などの文字列コマンド送受信ができる
✅ 完成2026/1/14/19:45

レベル1：データ受信の準備（音はまだ出ない）
目的：ADC側を“読むだけ”で成立させる
1-1) Cで /dev/ttyUSB1 を open/close
1-2) “何も来ない”のを確認（正常）
1-3) 受信バッファクリア（flush）を作る
1-4) 指定バイト数を確実に read してファイルに落とす（生データdump）
✅ 完成2026/1/14/19:51

レベル2：音が出る可能性がある
目的：パルス送信→ADCデータ取得を1回成功させる
2-1) Cで /dev/ttyUSB0 を open
2-2) 最小のパルスデータ（短時間）を送る
2-3) 同時に /dev/ttyUSB1 から指定バイト読む
2-4) 制御ポートで e を読んでエラー0を確認
⚠️ ここから音が出る可能性があります。
👉 必ず事前にあなたに「今からパルス送信します、OK？」と確認します。

レベル3：音として確認（波形/ファイル化）
目的：取れたADCが音になっていると確認
3-1) 生データ（LH LL RH RL）をエンディアン変換
3-2) WAVヘッダつけて保存（仕様書の注意通り）
3-3) 波形を目視 or スペクトルで確認
3-4) 実験条件を変えて再現性を見る（ゲイン/周波数/バイト数など）

ゴール
1.サーモホンから狙った波形（パルス列）を出す
2.マイクで受ける
3.ADCデータとして取得できる
4.取得データが「音として妥当」（波形/スペクトル/ファイル化）で確認できる

